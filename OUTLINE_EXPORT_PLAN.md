# Plan: Outline → Docusaurus Export Pipeline

## Context
Export a specific Outline collection to the existing Docusaurus project (`integr8-docs`) via API, auto-generate frontmatter/slugs, handle images locally (Bunny.net CDN documented as future phase), then auto-build and deploy to GitHub Pages via a scheduled GitHub Actions cron job.

---

## Phase 1: Export Script

### Location
`integr8-docs/scripts/outline-export.ts`

A Node.js/TypeScript CLI script that syncs one Outline collection into the Docusaurus `docs/` directory.

### Steps
1. **Auth & config** — Read `OUTLINE_API_KEY` and `OUTLINE_COLLECTION_ID` from `.env` (never committed)
2. **Fetch document tree** — `POST /api/collections.documents` with `collectionId` → returns a `NavigationNode` tree preserving parent/child hierarchy
3. **Recursive export** — Walk the tree; for each document call `POST /api/documents.export` with `format: markdown`
4. **Frontmatter generation** — Auto-generate from document metadata:
   - `title` — from Outline document title
   - `slug` — slugify(title) e.g. `Getting Started` → `getting-started`
   - `sidebar_position` — from the node's index in its parent's children array
   - `description` — first non-empty paragraph of the document (if present)
5. **Folder structure** — Map Outline nesting depth to Docusaurus directory nesting under `docs/`; create `_category_.json` for each folder with `label` and `position`
6. **Image handling** — Detect image URLs in markdown (Outline attachment URLs); download each image to `static/img/outline/`; rewrite inline URLs to `/img/outline/<filename>`
7. **Rate limiting** — Exponential backoff on `429` responses

### Dependencies to add
- `slugify` — slug generation
- `node-fetch` or native `fetch` (Node ≥ 20) — API calls
- `dotenv` — env var loading
- `fs-extra` — file system helpers

### Config file
`integr8-docs/scripts/outline-export.config.ts` (or `.json`) — optional overrides for output path, image directory, etc.

---

## Phase 2: Docusaurus Build

No Docusaurus config changes needed beyond ensuring `sidebars.ts` stays on `autogenerated`. After the export script runs:

```bash
cd integr8-docs
npm run build     # outputs to build/
npm run serve     # preview locally
```

Update `docusaurus.config.ts`:
- `url` → actual GitHub Pages URL (e.g. `https://luismgoyone.github.io`)
- `baseUrl` → `/integr8-docs/`
- `organizationName` → `luismgoyone`
- `projectName` → `integr8-docs`

---

## Phase 3: GitHub Actions

### Workflow 1: Scheduled Sync + Commit (`sync.yml`)
Cron schedule (e.g. nightly at 2am UTC):
1. Checkout repo
2. Setup Node 20
3. Install dependencies (`npm ci`)
4. Run `npx ts-node scripts/outline-export.ts`
5. Check for changes (`git status`)
6. If changes exist → commit with message `chore: sync from Outline [date]` and push

Secrets needed: `OUTLINE_API_KEY`, `OUTLINE_COLLECTION_ID`

### Workflow 2: Build & Deploy (`deploy.yml`)
Triggered on push to `main` (which the sync workflow triggers):
1. Checkout repo
2. Setup Node 20
3. `npm ci && npm run build`
4. Deploy `build/` to GitHub Pages using `actions/deploy-pages`

---

## Bunny.net CDN Strategy (documented, not implemented in Phase 1)

When ready to implement:
- In the export script, replace local image saving with Bunny.net Storage API (`PUT https://storage.bunnycdn.com/{storageZone}/img/outline/{filename}`)
- Auth: `AccessKey` header with Bunny.net API key
- Rewrite image URLs to `https://{pullZone}.b-cdn.net/img/outline/{filename}` instead of `/img/outline/{filename}`
- Env vars to add: `BUNNY_STORAGE_ZONE`, `BUNNY_API_KEY`, `BUNNY_CDN_URL`
- This makes images globally edge-cached and removes them from the git repo

---

## Critical Files

| File | Action |
|------|--------|
| `integr8-docs/scripts/outline-export.ts` | **Create** — main export script |
| `integr8-docs/.env.example` | **Create** — documents required env vars |
| `integr8-docs/package.json` | **Edit** — add `ts-node`, `slugify`, `fs-extra`, `dotenv` + export script |
| `integr8-docs/docusaurus.config.ts` | **Edit** — set real URL, baseUrl, org/project names |
| `integr8-docs/.github/workflows/sync.yml` | **Create** — scheduled Outline sync |
| `integr8-docs/.github/workflows/deploy.yml` | **Create** — build & deploy to GitHub Pages |
| `integr8-docs/.gitignore` | **Edit** — add `.env` |

---

## Verification

1. Run `npx ts-node scripts/outline-export.ts` locally → confirm `docs/` is populated with correct markdown + frontmatter
2. Run `npm run start` → verify sidebar structure matches Outline collection hierarchy
3. Run `npm run build` → confirm no broken links
4. Push to GitHub → confirm both workflows trigger and site deploys to GitHub Pages URL
